# RocketChat installation 

Depends on [nfs-subdir-external-provisioner](https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner) as storage for file uploads.
It's able to terminate TLS connections at the ingress Nginx with Let's Encrypt certificate generated by cert-manager.

Comprises of a RocketChat server and 3 MongoDB replicaset.

Note that MongoDB 5.0 and later require CPUs with AVX, therefore configure the worker node VMs in Proxmox to use the Host CPU.

### Create new ZFS filesystem and share
Creates the ZFS filesystem and share, restricting mount access to the cluster nodes only.

```
# zfs create tank/rocketchat-attachments
# zfs set quota=200G tank/rocketchat-attachments
# zfs set sharenfs="rw=@<NODE-1-IP>,sync,no_subtree_check,no_root_squash,rw=@<NODE-2-IP>,sync,no_subtree_check,no_root_squash,rw=@<NODE-3-IP>,sync,no_subtree_check,no_root_squash" tank/rocketchat-attachments
```

Test share:

```
# showmount -e <NFS-SERVER>
# sudo mount -t nfs <NFS-SERVER>:/tank/rocketchat-attachments <MOUNT-POINT>
```

### Install

```
kubectl apply -f nfs.yml
kubectl apply -f ingress.yml
kubectl apply -f mongo.yml
```

Once Mongo pods are up and running, initiate the replica set[[1](https://ajorloo.medium.com/deploy-rocket-chat-server-using-kubernetes-2d6c4228853)].

```
k exec -it -n home-apps rocketmongo-0 -- sh
mongosh
rs.initiate()
var config = rs.conf()
config.members[0].host="rocketmongo-0.rocketmongo:27017"
rs.reconfig(config)
rs.add("rocketmongo-1.rocketmongo:27017")
rs.add("rocketmongo-2.rocketmongo:27017")
rs.status()
```

The finally:
```
kubectl apply -f rocketchat.yml
```
